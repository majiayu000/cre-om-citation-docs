<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Citation System Technical Specification</title>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-light: #dbeafe;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-600: #4b5563;
      --gray-800: #1f2937;
      --green-100: #dcfce7;
      --green-700: #15803d;
      --yellow-100: #fef9c3;
      --yellow-700: #a16207;
      --red-100: #fee2e2;
      --red-700: #b91c1c;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: var(--gray-800);
      background: var(--gray-50);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    header {
      background: linear-gradient(135deg, var(--primary), #1d4ed8);
      color: white;
      padding: 3rem 2rem;
      margin-bottom: 2rem;
      border-radius: 12px;
    }

    header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    header p {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .meta {
      display: flex;
      gap: 2rem;
      margin-top: 1rem;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    nav {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    nav h2 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: var(--gray-600);
    }

    nav ul {
      list-style: none;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 0.5rem;
    }

    nav a {
      color: var(--primary);
      text-decoration: none;
      padding: 0.5rem;
      display: block;
      border-radius: 6px;
      transition: background 0.2s;
    }

    nav a:hover {
      background: var(--primary-light);
    }

    section {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    h2 {
      color: var(--primary);
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--primary-light);
    }

    h3 {
      font-size: 1.3rem;
      margin: 1.5rem 0 1rem;
      color: var(--gray-800);
    }

    h4 {
      font-size: 1.1rem;
      margin: 1rem 0 0.5rem;
      color: var(--gray-600);
    }

    p {
      margin-bottom: 1rem;
    }

    .diagram-container {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 1.5rem;
      margin: 1.5rem 0;
      overflow-x: auto;
      position: relative;
    }

    .diagram-container .mermaid {
      display: flex;
      justify-content: center;
      min-height: 300px;
    }

    .diagram-title {
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--gray-600);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .fullscreen-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background 0.2s;
    }

    .fullscreen-btn:hover {
      background: #1d4ed8;
    }

    .diagram-container.fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      border-radius: 0;
      margin: 0;
      background: white;
      display: flex;
      flex-direction: column;
    }

    .diagram-container.fullscreen .mermaid {
      flex: 1;
      overflow: auto;
      min-height: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }

    th, td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid var(--gray-200);
    }

    th {
      background: var(--gray-100);
      font-weight: 600;
    }

    tr:hover {
      background: var(--gray-50);
    }

    code {
      background: var(--gray-100);
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.9em;
    }

    pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 1.5rem;
      border-radius: 8px;
      overflow-x: auto;
      margin: 1rem 0;
    }

    pre code {
      background: none;
      padding: 0;
      color: inherit;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .badge-excel { background: var(--green-100); color: var(--green-700); }
    .badge-pdf { background: var(--red-100); color: var(--red-700); }
    .badge-user { background: #f3e8ff; color: #7c3aed; }
    .badge-search { background: var(--primary-light); color: var(--primary); }
    .badge-location { background: #ffedd5; color: #c2410c; }
    .badge-override { background: var(--yellow-100); color: var(--yellow-700); }

    .principles-box {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 1px solid #bae6fd;
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .principles-box h4 {
      color: #0369a1;
      margin-top: 0;
    }

    .principles-box ul {
      list-style: none;
      margin: 0;
    }

    .principles-box li {
      padding: 0.5rem 0;
      padding-left: 1.5rem;
      position: relative;
    }

    .principles-box li::before {
      content: ">";
      position: absolute;
      left: 0;
      color: var(--primary);
      font-weight: bold;
    }

    .decision-table {
      margin: 1.5rem 0;
    }

    .source-types {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .source-type-card {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 1rem;
    }

    .source-type-card .icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .source-type-card h5 {
      margin: 0.5rem 0;
      font-size: 1rem;
    }

    .source-type-card p {
      font-size: 0.875rem;
      color: var(--gray-600);
      margin: 0;
    }

    .code-tabs {
      margin: 1.5rem 0;
    }

    .code-tabs-nav {
      display: flex;
      gap: 0.5rem;
      margin-bottom: -1px;
    }

    .code-tabs-nav button {
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      border-bottom: none;
      padding: 0.5rem 1rem;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      font-size: 0.875rem;
    }

    .code-tabs-nav button.active {
      background: #1e293b;
      color: white;
      border-color: #1e293b;
    }

    .api-endpoint {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
    }

    .api-endpoint .method {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.875rem;
      margin-right: 0.5rem;
    }

    .api-endpoint .method.get { background: #dcfce7; color: #15803d; }
    .api-endpoint .method.post { background: #dbeafe; color: #1d4ed8; }
    .api-endpoint .method.patch { background: #fef9c3; color: #a16207; }
    .api-endpoint .method.delete { background: #fee2e2; color: #b91c1c; }

    .api-endpoint .path {
      font-family: monospace;
      font-size: 0.95rem;
    }

    .performance-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .metric-card {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }

    .metric-card .value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }

    .metric-card .label {
      font-size: 0.875rem;
      color: var(--gray-600);
      margin-top: 0.25rem;
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      header {
        padding: 2rem 1rem;
      }

      header h1 {
        font-size: 1.8rem;
      }

      .meta {
        flex-direction: column;
        gap: 0.5rem;
      }

      nav ul {
        grid-template-columns: 1fr;
      }

      section {
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Citation System Technical Specification</h1>
      <p>CRE OM Generator - æ•°æ®æº¯æºç³»ç»ŸæŠ€æœ¯è§„èŒƒ</p>
      <div class="meta">
        <span>Version: 1.0.0</span>
        <span>Last Updated: 2026-01-12</span>
        <span>Author: Engineering Team</span>
      </div>
    </header>

    <nav>
      <h2>ç›®å½•</h2>
      <ul>
        <li><a href="#overview">1. ç³»ç»Ÿæ¦‚è¿°</a></li>
        <li><a href="#concepts">2. æ ¸å¿ƒæ¦‚å¿µ</a></li>
        <li><a href="#data-model">3. æ•°æ®æ¨¡å‹</a></li>
        <li><a href="#architecture">4. ç³»ç»Ÿæ¶æ„</a></li>
        <li><a href="#flows">5. æ ¸å¿ƒæµç¨‹</a></li>
        <li><a href="#api">6. API è®¾è®¡</a></li>
        <li><a href="#components">7. å‰ç«¯ç»„ä»¶</a></li>
        <li><a href="#storage">8. å­˜å‚¨æ–¹æ¡ˆ</a></li>
        <li><a href="#errors">9. é”™è¯¯å¤„ç†</a></li>
        <li><a href="#performance">10. æ€§èƒ½ä¼˜åŒ–</a></li>
      </ul>
    </nav>

    <!-- Section 1: ç³»ç»Ÿæ¦‚è¿° -->
    <section id="overview">
      <h2>1. ç³»ç»Ÿæ¦‚è¿°</h2>

      <h3>1.1 ä»€ä¹ˆæ˜¯ Citation</h3>
      <p>Citationï¼ˆæ•°æ®æº¯æºï¼‰æ˜¯ CRE OM Generator çš„æ ¸å¿ƒå·®å¼‚åŒ–åŠŸèƒ½ã€‚å®ƒä¸º AI ç”Ÿæˆçš„æ¯ä¸€ä¸ªæ•°æ®ç‚¹å»ºç«‹åˆ°åŸå§‹æ–‡æ¡£çš„ç²¾ç¡®è¿½æº¯é“¾æ¥ã€‚</p>

      <div class="principles-box">
        <h4>Citation æ ¸å¿ƒä»·å€¼</h4>
        <ul>
          <li><strong>å¯éªŒè¯æ€§</strong> - ç”¨æˆ·å¯ä»¥ä¸€é”®æŸ¥çœ‹ä»»ä½•æ•°æ®çš„åŸå§‹æ¥æº</li>
          <li><strong>å¯ç¼–è¾‘æ€§</strong> - ç”¨æˆ·å¯ä»¥ä¿®æ”¹æ•°æ®å¹¶è®°å½•ä¿®æ”¹åŸå› </li>
          <li><strong>é€æ˜æ€§</strong> - æ¸…æ™°åŒºåˆ†æ•°æ®æ¥æºç±»å‹ï¼ˆExcel/PDF/ç”¨æˆ·è¾“å…¥ç­‰ï¼‰</li>
        </ul>
      </div>

      <h3>1.2 è®¾è®¡åŸåˆ™</h3>
      <div class="diagram-container">
        <div class="diagram-title">
          <span>Citation è®¾è®¡åŸåˆ™</span>
          <button class="fullscreen-btn" onclick="toggleFullscreen(this)">å…¨å±</button>
        </div>
        <div class="mermaid">
graph LR
    subgraph "è®¾è®¡åŸåˆ™"
        P1[ç²¾ç¡®å®šä½<br/>Excelåˆ°Cell<br/>PDFåˆ°Page]
        P2[ä¸ç”¨Embedding<br/>ç»“æ„åŒ–æ•°æ®<br/>ç›´æ¥Contextæ³¨å…¥]
        P3[ç®€å•æ¥æºç±»å‹<br/>sourceTypeæ›¿ä»£<br/>ç½®ä¿¡åº¦è®¡ç®—]
        P4[ç”¨æˆ·å¯æ§<br/>æ”¯æŒæ‰‹åŠ¨è¦†ç›–<br/>è®°å½•ä¿®æ”¹åŸå› ]
        P5[é«˜æ€§èƒ½æ¸²æŸ“<br/>è™šæ‹ŸåŒ–åˆ—è¡¨<br/>æŒ‰éœ€åŠ è½½]
    end

    P1 --> P2 --> P3 --> P4 --> P5
        </div>
      </div>

      <h3>1.3 æŠ€æœ¯å†³ç­–</h3>
      <table class="decision-table">
        <thead>
          <tr>
            <th>å†³ç­–ç‚¹</th>
            <th>é€‰æ‹©</th>
            <th>åŸå› </th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>æ˜¯å¦éœ€è¦ Embedding</td>
            <td><strong>å¦</strong></td>
            <td>æ•°æ®é‡å°(&lt;10K tokens)ï¼Œç›´æ¥ Context æ³¨å…¥</td>
          </tr>
          <tr>
            <td>ç½®ä¿¡åº¦è®¡ç®—</td>
            <td><strong>ç§»é™¤</strong></td>
            <td>å¢åŠ å¤æ‚åº¦ä½†ä»·å€¼æœ‰é™ï¼Œæ”¹ç”¨ sourceType</td>
          </tr>
          <tr>
            <td>æ–‡æ¡£è§£æ</td>
            <td><strong>ç›´æ¥ç”¨åº“</strong></td>
            <td>openpyxl/pdfplumberï¼Œå®Œå…¨æ§åˆ¶ Citation æ ¼å¼</td>
          </tr>
          <tr>
            <td>å­˜å‚¨æ–¹å¼</td>
            <td><strong>PostgreSQL JSONB</strong></td>
            <td>çµæ´» schema + å…³ç³»æŸ¥è¯¢</td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- Section 2: æ ¸å¿ƒæ¦‚å¿µ -->
    <section id="concepts">
      <h2>2. æ ¸å¿ƒæ¦‚å¿µ</h2>

      <h3>2.1 æ¦‚å¿µå…³ç³»å›¾</h3>
      <div class="diagram-container">
        <div class="diagram-title">
          <span>Citation æ¦‚å¿µå…³ç³»</span>
          <button class="fullscreen-btn" onclick="toggleFullscreen(this)">å…¨å±</button>
        </div>
        <div class="mermaid">
graph TB
    subgraph "åŸå§‹æ•°æ®å±‚"
        DOC[Document<br/>ä¸Šä¼ çš„æ–‡ä»¶]
        EXCEL[Excel File]
        PDF[PDF File]
        DS[Deep Search Result]
    end

    subgraph "è§£æå±‚"
        PARSER[Document Parser]
        CELL[Cell Data<br/>Sheet + Cellåæ ‡]
        PAGE[Page Data<br/>é¡µç  + æ®µè½]
        URL[URL Data<br/>æ¥æºé“¾æ¥]
    end

    subgraph "Citationå±‚"
        CIT[Citation Record<br/>æº¯æºè®°å½•]
        SRC[Source Info<br/>æ¥æºä¿¡æ¯]
        POS[Position Info<br/>ä½ç½®ä¿¡æ¯]
        VAL[Value Info<br/>å€¼ä¿¡æ¯]
    end

    subgraph "å†…å®¹å±‚"
        BLOCK[Content Block<br/>OMå†…å®¹å—]
        SEC[Section<br/>ç« èŠ‚]
        OM[OM Report<br/>æœ€ç»ˆæŠ¥å‘Š]
    end

    DOC --> EXCEL
    DOC --> PDF
    DS --> URL

    EXCEL --> PARSER
    PDF --> PARSER
    URL --> PARSER

    PARSER --> CELL
    PARSER --> PAGE
    PARSER --> URL

    CELL --> CIT
    PAGE --> CIT
    URL --> CIT

    CIT --> SRC
    CIT --> POS
    CIT --> VAL

    CIT --> BLOCK
    BLOCK --> SEC
    SEC --> OM

    style CIT fill:#e1f5fe
    style BLOCK fill:#fff3e0
        </div>
      </div>

      <h3>2.2 sourceType ç±»å‹è¯´æ˜</h3>
      <div class="source-types">
        <div class="source-type-card">
          <div class="icon">ğŸ“Š</div>
          <h5><span class="badge badge-excel">excel</span></h5>
          <p>Excel å•å…ƒæ ¼æ•°æ®<br/>å¦‚: Cell D12</p>
        </div>
        <div class="source-type-card">
          <div class="icon">ğŸ“„</div>
          <h5><span class="badge badge-pdf">pdf</span></h5>
          <p>PDF æ–‡æ¡£å†…å®¹<br/>å¦‚: Page 15</p>
        </div>
        <div class="source-type-card">
          <div class="icon">ğŸ‘¤</div>
          <h5><span class="badge badge-user">user</span></h5>
          <p>ç”¨æˆ·ç›´æ¥è¾“å…¥<br/>è¡¨å•å¡«å†™</p>
        </div>
        <div class="source-type-card">
          <div class="icon">ğŸ”</div>
          <h5><span class="badge badge-search">deep_search</span></h5>
          <p>Deep Search ç»“æœ<br/>CoStar, Zillowç­‰</p>
        </div>
        <div class="source-type-card">
          <div class="icon">ğŸ“</div>
          <h5><span class="badge badge-location">location</span></h5>
          <p>Location Agent<br/>Google Places POI</p>
        </div>
        <div class="source-type-card">
          <div class="icon">âœï¸</div>
          <h5><span class="badge badge-override">manual_override</span></h5>
          <p>ç”¨æˆ·ä¿®æ”¹å€¼<br/>éœ€è¯´æ˜åŸå› </p>
        </div>
      </div>

      <div class="diagram-container">
        <div class="diagram-title">
          <span>sourceType ä¿¡ä»»å±‚çº§</span>
          <button class="fullscreen-btn" onclick="toggleFullscreen(this)">å…¨å±</button>
        </div>
        <div class="mermaid">
graph LR
    subgraph "æ•°æ®æ¥æºç±»å‹ (sourceType)"
        EXCEL[excel<br/>ğŸ“Š Excelæ–‡ä»¶]
        PDF[pdf<br/>ğŸ“„ PDFæ–‡æ¡£]
        USER[user<br/>ğŸ‘¤ ç”¨æˆ·è¾“å…¥]
        DEEP[deep_search<br/>ğŸ” æ·±åº¦æœç´¢]
        LOC[location<br/>ğŸ“ ä½ç½®æ™ºèƒ½]
        MANUAL[manual_override<br/>âœï¸ æ‰‹åŠ¨ä¿®æ”¹]
    end

    EXCEL --> |"æœ€å¯ä¿¡"| TRUST[ä¿¡ä»»ç­‰çº§]
    PDF --> TRUST
    USER --> TRUST
    DEEP --> |"éœ€éªŒè¯"| TRUST
    LOC --> TRUST
    MANUAL --> |"ç”¨æˆ·ç¡®è®¤"| TRUST
        </div>
      </div>
    </section>

    <!-- Section 3: æ•°æ®æ¨¡å‹ -->
    <section id="data-model">
      <h2>3. æ•°æ®æ¨¡å‹</h2>

      <h3>3.1 Citation æ ¸å¿ƒç»“æ„</h3>
      <div class="diagram-container">
        <div class="diagram-title">
          <span>Citation æ•°æ®ç»“æ„</span>
          <button class="fullscreen-btn" onclick="toggleFullscreen(this)">å…¨å±</button>
        </div>
        <div class="mermaid">
classDiagram
    class Citation {
        +string id
        +string contentBlockId
        +Source source
        +Position position
        +string originalValue
        +string displayValue
        +string snippet
        +SourceType sourceType
        +Date extractedAt
        +boolean isManualOverride
        +string overrideReason
    }

    class Source {
        +string documentId
        +string documentName
        +DocumentType documentType
    }

    class Position {
        +string type
        +string sheet
        +string cell
        +number page
    }

    class ContentBlock {
        +string id
        +string sectionId
        +string type
        +string content
        +Citation[] citations
    }

    Citation --> Source
    Citation --> Position
    ContentBlock --> Citation
        </div>
      </div>

      <h3>3.2 TypeScript æ¥å£å®šä¹‰</h3>
      <pre><code>interface Citation {
  // æ ‡è¯†ä¿¡æ¯
  id: string;                      // UUID
  contentBlockId: string;          // å…³è”çš„å†…å®¹å—ID

  // æ¥æºä¿¡æ¯
  source: {
    documentId: string;            // åŸå§‹æ–‡æ¡£ID
    documentName: string;          // å¦‚ "Underwriting Model.xlsx"
    documentType: 'excel' | 'pdf' | 'word' | 'image' | 'deep_search';
  };

  // ä½ç½®ä¿¡æ¯
  position: {
    type: 'cell' | 'range' | 'page' | 'paragraph' | 'url';
    sheet?: string;                // Excelå·¥ä½œè¡¨å
    cell?: string;                 // å•å…ƒæ ¼ï¼Œå¦‚"D12"
    page?: number;                 // PDFé¡µç 
    url?: string;                  // Deep Searchæ¥æºURL
  };

  // å€¼ä¿¡æ¯
  originalValue: string;           // åŸå§‹å€¼, å¦‚ "15900000"
  displayValue: string;            // æ˜¾ç¤ºå€¼, å¦‚ "$15.9M"
  snippet: string;                 // ä¸Šä¸‹æ–‡ç‰‡æ®µ (<100å­—ç¬¦)

  // å…ƒä¿¡æ¯
  sourceType: 'excel' | 'pdf' | 'user' | 'deep_search' | 'location' | 'manual_override';
  extractedAt: Date;

  // ä¿®æ”¹è¿½è¸ª
  isManualOverride: boolean;
  overrideReason?: string;
  previousValue?: string;
}</code></pre>
    </section>

    <!-- Section 4: ç³»ç»Ÿæ¶æ„ -->
    <section id="architecture">
      <h2>4. ç³»ç»Ÿæ¶æ„</h2>

      <h3>4.1 æ•´ä½“æ¶æ„å›¾</h3>
      <div class="diagram-container">
        <div class="diagram-title">
          <span>Citation ç³»ç»Ÿæ¶æ„</span>
          <button class="fullscreen-btn" onclick="toggleFullscreen(this)">å…¨å±</button>
        </div>
        <div class="mermaid">
flowchart TB
    subgraph "å‰ç«¯å±‚ Next.js"
        UI[OM Editor UI]
        CIT_COMP[Citation Components]
        PREVIEW[Citation Preview]
    end

    subgraph "APIå±‚ tRPC"
        UPLOAD[upload.file]
        PARSE[document.parse]
        GEN[om.generate]
        CIT_API[citation.query]
        EDIT[citation.override]
    end

    subgraph "ä¸šåŠ¡å±‚"
        DOC_PARSER[Document Parser<br/>æ–‡æ¡£è§£æå™¨]
        CIT_BINDER[Citation Binder<br/>æº¯æºç»‘å®šå™¨]
        AI_GEN[AI Generator<br/>å†…å®¹ç”Ÿæˆå™¨]
    end

    subgraph "è§£æå·¥å…·"
        OPENPYXL[openpyxl<br/>Excelè§£æ]
        PDFPLUMBER[pdfplumber<br/>PDFè§£æ]
    end

    subgraph "å­˜å‚¨å±‚"
        PG[(PostgreSQL<br/>Citation + Blocks)]
        S3[(S3<br/>åŸå§‹æ–‡ä»¶)]
    end

    subgraph "AIå±‚"
        CLAUDE[Claude API<br/>Contextæ³¨å…¥]
    end

    UI --> CIT_COMP
    CIT_COMP --> PREVIEW

    UI --> UPLOAD
    UI --> GEN
    CIT_COMP --> CIT_API
    CIT_COMP --> EDIT

    UPLOAD --> DOC_PARSER
    PARSE --> DOC_PARSER
    GEN --> AI_GEN
    CIT_API --> PG
    EDIT --> PG

    DOC_PARSER --> OPENPYXL
    DOC_PARSER --> PDFPLUMBER
    DOC_PARSER --> CIT_BINDER

    AI_GEN --> CLAUDE
    AI_GEN --> CIT_BINDER

    CIT_BINDER --> PG
    DOC_PARSER --> S3

    style CIT_BINDER fill:#e1f5fe
    style CIT_COMP fill:#fff3e0
        </div>
      </div>

      <h3>4.2 æ•°æ®æµå‘å›¾</h3>
      <div class="diagram-container">
        <div class="diagram-title">
          <span>æ•°æ®æµå‘</span>
          <button class="fullscreen-btn" onclick="toggleFullscreen(this)">å…¨å±</button>
        </div>
        <div class="mermaid">
flowchart LR
    subgraph "è¾“å…¥"
        F1[Excelæ–‡ä»¶]
        F2[PDFæ–‡ä»¶]
        F3[ç”¨æˆ·è¾“å…¥]
    end

    subgraph "è§£ææå–"
        P1[openpyxl<br/>Cellä½ç½®]
        P2[pdfplumber<br/>Pageä½ç½®]
        P3[è¡¨å•å¤„ç†<br/>å­—æ®µå]
    end

    subgraph "ç»“æ„åŒ–æ•°æ®"
        D1[ExtractedData<br/>å¸¦ä½ç½®ä¿¡æ¯]
    end

    subgraph "AIç”Ÿæˆ"
        AI[Claude API<br/>Contextæ³¨å…¥]
    end

    subgraph "Citationç»‘å®š"
        B1[åŒ¹é…ç”Ÿæˆå†…å®¹<br/>ä¸åŸå§‹æ•°æ®]
        B2[åˆ›å»ºCitation]
    end

    subgraph "è¾“å‡º"
        O1[OM Report<br/>å¸¦Citationæ ‡è®°]
        O2[Citation Records<br/>å­˜å‚¨DB]
    end

    F1 --> P1
    F2 --> P2
    F3 --> P3

    P1 --> D1
    P2 --> D1
    P3 --> D1

    D1 --> AI
    AI --> B1
    D1 --> B1

    B1 --> B2
    B2 --> O1
    B2 --> O2
        </div>
      </div>
    </section>

    <!-- Section 5: æ ¸å¿ƒæµç¨‹ -->
    <section id="flows">
      <h2>5. æ ¸å¿ƒæµç¨‹</h2>

      <h3>5.1 æ–‡æ¡£ä¸Šä¼ ä¸è§£ææµç¨‹</h3>
      <div class="diagram-container">
        <div class="diagram-title">
          <span>æ–‡æ¡£ä¸Šä¼ è§£ææ—¶åºå›¾</span>
          <button class="fullscreen-btn" onclick="toggleFullscreen(this)">å…¨å±</button>
        </div>
        <div class="mermaid">
sequenceDiagram
    autonumber
    participant User as ç”¨æˆ·
    participant UI as å‰ç«¯
    participant API as APIå±‚
    participant Parser as æ–‡æ¡£è§£æå™¨
    participant S3 as S3å­˜å‚¨
    participant DB as æ•°æ®åº“

    User->>UI: ä¸Šä¼ æ–‡ä»¶ (Excel/PDF)
    UI->>API: POST /api/upload
    API->>S3: å­˜å‚¨åŸå§‹æ–‡ä»¶
    S3-->>API: è¿”å› s3Key

    API->>Parser: è§£ææ–‡æ¡£

    alt Excelæ–‡ä»¶
        Parser->>Parser: openpyxl.load_workbook()
        Parser->>Parser: éå†æ‰€æœ‰Sheet
        Parser->>Parser: æå–Cellåæ ‡+å€¼
    else PDFæ–‡ä»¶
        Parser->>Parser: pdfplumber.open()
        Parser->>Parser: éå†æ‰€æœ‰Page
        Parser->>Parser: æå–Page+æ®µè½+å€¼
    end

    Parser-->>API: è¿”å›ExtractedData[]
    API->>DB: å­˜å‚¨Documentè®°å½•
    API->>DB: å­˜å‚¨ExtractedData JSONB

    API-->>UI: è¿”å›è§£æç»“æœ
    UI-->>User: æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨+é¢„è§ˆ
        </div>
      </div>

      <h3>5.2 OMç”Ÿæˆä¸Citationç»‘å®šæµç¨‹</h3>
      <div class="diagram-container">
        <div class="diagram-title">
          <span>OMç”Ÿæˆç»‘å®šæ—¶åºå›¾</span>
          <button class="fullscreen-btn" onclick="toggleFullscreen(this)">å…¨å±</button>
        </div>
        <div class="mermaid">
sequenceDiagram
    autonumber
    participant User as ç”¨æˆ·
    participant UI as å‰ç«¯
    participant API as APIå±‚
    participant Gen as AIç”Ÿæˆå™¨
    participant Binder as Citationç»‘å®šå™¨
    participant Claude as Claude API
    participant DB as æ•°æ®åº“

    User->>UI: ç‚¹å‡»ç”ŸæˆOM
    UI->>API: POST /api/om/generate

    API->>DB: è·å–é¡¹ç›®ExtractedData
    DB-->>API: è¿”å›ç»“æ„åŒ–æ•°æ®

    API->>Gen: ç”Ÿæˆè¯·æ±‚+æ•°æ®
    Gen->>Gen: æ„å»ºPrompt<br/>æ•°æ®ç›´æ¥æ³¨å…¥Context
    Gen->>Claude: å‘é€è¯·æ±‚
    Claude-->>Gen: è¿”å›ç”Ÿæˆå†…å®¹

    Gen->>Binder: å†…å®¹+ExtractedData

    loop æ¯ä¸ªæ•°æ®ç‚¹
        Binder->>Binder: åŒ¹é…ç”Ÿæˆå†…å®¹ä¸­çš„å€¼
        Binder->>Binder: åˆ›å»ºCitationè®°å½•
        Binder->>Binder: æ’å…¥Citationæ ‡è®°
    end

    Binder-->>API: è¿”å›å¸¦æ ‡è®°å†…å®¹+Citations

    API->>DB: å­˜å‚¨ContentBlocks
    API->>DB: å­˜å‚¨Citations

    API-->>UI: è¿”å›OMå†…å®¹
    UI-->>User: æ¸²æŸ“å¸¦CitationæŠ¥å‘Š
        </div>
      </div>

      <h3>5.3 CitationæŸ¥çœ‹æµç¨‹</h3>
      <div class="diagram-container">
        <div class="diagram-title">
          <span>CitationæŸ¥çœ‹æ—¶åºå›¾</span>
          <button class="fullscreen-btn" onclick="toggleFullscreen(this)">å…¨å±</button>
        </div>
        <div class="mermaid">
sequenceDiagram
    autonumber
    participant User as ç”¨æˆ·
    participant UI as Citationç»„ä»¶
    participant API as APIå±‚
    participant DB as æ•°æ®åº“
    participant S3 as S3å­˜å‚¨

    User->>UI: Hover Citationæ ‡è®°
    UI->>UI: æ˜¾ç¤ºç®€ç•¥ä¿¡æ¯<br/>ä»ç¼“å­˜

    User->>UI: ç‚¹å‡»Citationæ ‡è®°
    UI->>API: GET /api/citation/:id
    API->>DB: æŸ¥è¯¢Citationè¯¦æƒ…
    DB-->>API: è¿”å›Citationè®°å½•

    alt sourceType = excel
        API->>S3: è·å–Excelæ–‡ä»¶
        S3-->>API: è¿”å›æ–‡ä»¶
        API->>API: è¯»å–å‘¨å›´Cellå†…å®¹
    else sourceType = pdf
        API->>S3: è·å–PDFæ–‡ä»¶
        S3-->>API: è¿”å›æ–‡ä»¶
        API->>API: æå–é¡µé¢æˆªå›¾/æ–‡æœ¬
    end

    API-->>UI: è¿”å›å®Œæ•´Citation+Preview
    UI->>UI: æ¸²æŸ“Citation Popover
    UI-->>User: æ˜¾ç¤ºæ¥æºè¯¦æƒ…+é¢„è§ˆ
        </div>
      </div>

      <h3>5.4 Citationä¿®æ”¹æµç¨‹</h3>
      <div class="diagram-container">
        <div class="diagram-title">
          <span>Citationä¿®æ”¹æ—¶åºå›¾</span>
          <button class="fullscreen-btn" onclick="toggleFullscreen(this)">å…¨å±</button>
        </div>
        <div class="mermaid">
sequenceDiagram
    autonumber
    participant User as ç”¨æˆ·
    participant UI as Citationç»„ä»¶
    participant API as APIå±‚
    participant DB as æ•°æ®åº“

    User->>UI: ç‚¹å‡»Edit Value
    UI->>UI: æ˜¾ç¤ºç¼–è¾‘è¡¨å•

    User->>UI: è¾“å…¥æ–°å€¼+ä¿®æ”¹åŸå› 
    UI->>API: PATCH /api/citation/:id/override

    API->>DB: å¼€å¯äº‹åŠ¡
    API->>DB: æ›´æ–°Citation<br/>isManualOverride=true<br/>previousValue=æ—§å€¼<br/>overrideReason=åŸå› 
    API->>DB: æ›´æ–°ContentBlockå†…å®¹
    API->>DB: æäº¤äº‹åŠ¡

    API-->>UI: è¿”å›æ›´æ–°ç»“æœ
    UI->>UI: æ›´æ–°æ˜¾ç¤ºå€¼
    UI->>UI: æ·»åŠ å·²ä¿®æ”¹æ ‡è®°
    UI-->>User: æ˜¾ç¤ºä¿®æ”¹æˆåŠŸ
        </div>
      </div>

      <h3>5.5 Citation ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å›¾</h3>
      <div class="diagram-container">
        <div class="diagram-title">
          <span>Citation ç”Ÿå‘½å‘¨æœŸ</span>
          <button class="fullscreen-btn" onclick="toggleFullscreen(this)">å…¨å±</button>
        </div>
        <div class="mermaid">
stateDiagram-v2
    [*] --> Uploaded: ä¸Šä¼ æ–‡ä»¶

    Uploaded --> Parsing: å¼€å§‹è§£æ
    Parsing --> Parsed: è§£æå®Œæˆ
    Parsing --> ParseError: è§£æå¤±è´¥
    ParseError --> Uploaded: é‡æ–°ä¸Šä¼ 

    Parsed --> Extracted: æ•°æ®æå–å®Œæˆ
    Extracted --> Generating: ç”ŸæˆOM

    Generating --> Generated: ç”Ÿæˆå®Œæˆ
    Generating --> GenError: ç”Ÿæˆå¤±è´¥
    GenError --> Extracted: é‡è¯•ç”Ÿæˆ

    Generated --> Binding: Citationç»‘å®š
    Binding --> Bound: ç»‘å®šå®Œæˆ

    Bound --> Editing: ç”¨æˆ·ç¼–è¾‘
    Editing --> Bound: ä¿å­˜ä¿®æ”¹

    Bound --> Exporting: å¯¼å‡ºPDF
    Exporting --> [*]: å®Œæˆ
        </div>
      </div>
    </section>

    <!-- Section 6: API è®¾è®¡ -->
    <section id="api">
      <h2>6. API è®¾è®¡</h2>

      <h3>6.1 Citation API Endpoints</h3>

      <div class="api-endpoint">
        <span class="method get">GET</span>
        <span class="path">/api/citation/:id</span>
        <p>è·å–å•ä¸ª Citation è¯¦æƒ…</p>
      </div>

      <div class="api-endpoint">
        <span class="method get">GET</span>
        <span class="path">/api/citation/block/:contentBlockId</span>
        <p>è·å– ContentBlock çš„æ‰€æœ‰ Citations</p>
      </div>

      <div class="api-endpoint">
        <span class="method get">GET</span>
        <span class="path">/api/citation/:id/preview</span>
        <p>è·å– Citation çš„åŸå§‹æ–‡ä»¶é¢„è§ˆ</p>
      </div>

      <div class="api-endpoint">
        <span class="method patch">PATCH</span>
        <span class="path">/api/citation/:id/override</span>
        <p>ä¿®æ”¹ Citation å€¼ï¼ˆéœ€æä¾›ä¿®æ”¹åŸå› ï¼‰</p>
      </div>

      <div class="api-endpoint">
        <span class="method post">POST</span>
        <span class="path">/api/citation/:id/revert</span>
        <p>æ’¤é”€ Citation ä¿®æ”¹ï¼Œæ¢å¤åŸå€¼</p>
      </div>

      <h3>6.2 tRPC Router ç¤ºä¾‹</h3>
      <pre><code>export const citationRouter = router({
  // è·å–å•ä¸ªCitationè¯¦æƒ…
  getById: publicProcedure
    .input(z.object({ id: z.string().uuid() }))
    .query(async ({ input, ctx }) => {
      return ctx.db.citation.findUnique({
        where: { id: input.id },
        include: { document: true }
      });
    }),

  // ä¿®æ”¹Citationå€¼
  override: publicProcedure
    .input(z.object({
      id: z.string().uuid(),
      newValue: z.string(),
      reason: z.string().min(1).max(500)
    }))
    .mutation(async ({ input, ctx }) => {
      return ctx.db.$transaction(async (tx) => {
        const updated = await tx.citation.update({
          where: { id: input.id },
          data: {
            displayValue: input.newValue,
            isManualOverride: true,
            overrideReason: input.reason,
            sourceType: 'manual_override'
          }
        });
        return updated;
      });
    }),
});</code></pre>
    </section>

    <!-- Section 7: å‰ç«¯ç»„ä»¶ -->
    <section id="components">
      <h2>7. å‰ç«¯ç»„ä»¶</h2>

      <h3>7.1 ç»„ä»¶æ¶æ„</h3>
      <div class="diagram-container">
        <div class="diagram-title">
          <span>Citation ç»„ä»¶ä½“ç³»</span>
          <button class="fullscreen-btn" onclick="toggleFullscreen(this)">å…¨å±</button>
        </div>
        <div class="mermaid">
graph TB
    subgraph "Citationç»„ä»¶ä½“ç³»"
        MARKER[CitationMarker<br/>è¡Œå†…æ ‡è®°]
        TOOLTIP[CitationTooltip<br/>Hoverç®€ç•¥ä¿¡æ¯]
        POPOVER[CitationPopover<br/>ç‚¹å‡»è¯¦æƒ…å¼¹çª—]
        PREVIEW[CitationPreview<br/>åŸæ–‡é¢„è§ˆ]
        EDITOR[CitationEditor<br/>ç¼–è¾‘è¡¨å•]
        BADGE[SourceTypeBadge<br/>æ¥æºç±»å‹æ ‡ç­¾]
    end

    subgraph "å®¹å™¨ç»„ä»¶"
        PROVIDER[CitationProvider<br/>Contextæä¾›è€…]
        LIST[CitationList<br/>Sectionçº§åˆ«åˆ—è¡¨]
    end

    MARKER --> TOOLTIP
    MARKER --> POPOVER
    POPOVER --> PREVIEW
    POPOVER --> EDITOR
    POPOVER --> BADGE

    PROVIDER --> MARKER
    PROVIDER --> LIST
    LIST --> MARKER
        </div>
      </div>

      <h3>7.2 ç»„ä»¶äº¤äº’çŠ¶æ€</h3>
      <div class="diagram-container">
        <div class="diagram-title">
          <span>Citation ç»„ä»¶çŠ¶æ€æœº</span>
          <button class="fullscreen-btn" onclick="toggleFullscreen(this)">å…¨å±</button>
        </div>
        <div class="mermaid">
stateDiagram-v2
    [*] --> Idle: åˆå§‹çŠ¶æ€

    Idle --> Hovering: Mouse Enter
    Hovering --> Idle: Mouse Leave
    Hovering --> Open: Click

    Open --> Loading: é¦–æ¬¡æ‰“å¼€
    Loading --> Loaded: æ•°æ®è¿”å›
    Loading --> Error: åŠ è½½å¤±è´¥
    Error --> Loading: Retry

    Loaded --> Editing: ç‚¹å‡»Edit
    Editing --> Loaded: Cancel
    Editing --> Saving: Submit
    Saving --> Loaded: Success
    Saving --> Editing: Error

    Loaded --> Idle: Close Popover
        </div>
      </div>

      <h3>7.3 Citation Popover å±•ç¤º</h3>
      <pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š Citation Source                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Value: $15,900,000                      â”‚
â”‚ Source: ğŸ“Š Excel                        â”‚
â”‚ File: Underwriting Model.xlsx           â”‚
â”‚ Location: Sheet "Summary", Cell D12     â”‚
â”‚                                         â”‚
â”‚ Preview:                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ D11: Property Value                 â”‚ â”‚
â”‚ â”‚ D12: 15,900,000  â† this cell       â”‚ â”‚
â”‚ â”‚ D13: Cap Rate: 7.5%                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ [View Original File]  [Edit Value]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
    </section>

    <!-- Section 8: å­˜å‚¨æ–¹æ¡ˆ -->
    <section id="storage">
      <h2>8. å­˜å‚¨æ–¹æ¡ˆ</h2>

      <h3>8.1 å­˜å‚¨æ¶æ„</h3>
      <div class="diagram-container">
        <div class="diagram-title">
          <span>æ•°æ®å­˜å‚¨æ¶æ„</span>
          <button class="fullscreen-btn" onclick="toggleFullscreen(this)">å…¨å±</button>
        </div>
        <div class="mermaid">
graph TB
    subgraph "PostgreSQL"
        CITATIONS[(citations<br/>Citationè®°å½•)]
        BLOCKS[(content_blocks<br/>å†…å®¹å—)]
        DOCS[(documents<br/>æ–‡æ¡£å…ƒæ•°æ®)]
        EXTRACTED[(extracted_data<br/>è§£ææ•°æ®JSONB)]
    end

    subgraph "S3"
        RAW[/raw-files/<br/>åŸå§‹ä¸Šä¼ æ–‡ä»¶/]
        THUMB[/thumbnails/<br/>é¢„è§ˆç¼©ç•¥å›¾/]
    end

    subgraph "Redis å¯é€‰"
        CACHE[(Citationç¼“å­˜)]
        PREVIEW_CACHE[(Previewç¼“å­˜)]
    end

    CITATIONS --> BLOCKS
    CITATIONS --> DOCS
    DOCS --> EXTRACTED
    DOCS --> RAW
    DOCS --> THUMB

    CITATIONS -.-> CACHE
    CITATIONS -.-> PREVIEW_CACHE
        </div>
      </div>

      <h3>8.2 ç´¢å¼•ç­–ç•¥</h3>
      <pre><code>-- Citationè¡¨ç´¢å¼•
CREATE INDEX idx_citation_content_block ON citations(content_block_id);
CREATE INDEX idx_citation_document ON citations(document_id);
CREATE INDEX idx_citation_source_type ON citations(source_type);
CREATE INDEX idx_citation_override ON citations(is_manual_override)
  WHERE is_manual_override = true;

-- å¤åˆç´¢å¼• (å¸¸ç”¨æŸ¥è¯¢)
CREATE INDEX idx_citation_block_type ON citations(content_block_id, source_type);</code></pre>
    </section>

    <!-- Section 9: é”™è¯¯å¤„ç† -->
    <section id="errors">
      <h2>9. é”™è¯¯å¤„ç†</h2>

      <h3>9.1 é”™è¯¯å¤„ç†æµç¨‹</h3>
      <div class="diagram-container">
        <div class="diagram-title">
          <span>é”™è¯¯å¤„ç†æµç¨‹å›¾</span>
          <button class="fullscreen-btn" onclick="toggleFullscreen(this)">å…¨å±</button>
        </div>
        <div class="mermaid">
flowchart TB
    START[æ“ä½œè¯·æ±‚] --> CHECK{å‚æ•°æ ¡éªŒ}

    CHECK -->|å¤±è´¥| INVALID[è¿”å›å‚æ•°é”™è¯¯]
    CHECK -->|æˆåŠŸ| QUERY{æ•°æ®æŸ¥è¯¢}

    QUERY -->|æœªæ‰¾åˆ°| NOT_FOUND[è¿”å›404]
    QUERY -->|æˆåŠŸ| PROCESS{ä¸šåŠ¡å¤„ç†}

    PROCESS -->|è§£æå¤±è´¥| PARSE_ERR[è®°å½•æ—¥å¿—<br/>è¿”å›è§£æé”™è¯¯]
    PROCESS -->|æƒé™ä¸è¶³| AUTH_ERR[è¿”å›403]
    PROCESS -->|æˆåŠŸ| COMMIT{æäº¤äº‹åŠ¡}

    COMMIT -->|å¤±è´¥| ROLLBACK[å›æ»šäº‹åŠ¡<br/>è¿”å›500]
    COMMIT -->|æˆåŠŸ| SUCCESS[è¿”å›æˆåŠŸ]

    INVALID --> LOG[è®°å½•é”™è¯¯æ—¥å¿—]
    NOT_FOUND --> LOG
    PARSE_ERR --> LOG
    AUTH_ERR --> LOG
    ROLLBACK --> LOG

    LOG --> RESPONSE[è¿”å›é”™è¯¯å“åº”]
        </div>
      </div>

      <h3>9.2 é”™è¯¯ç±»å‹</h3>
      <table>
        <thead>
          <tr>
            <th>é”™è¯¯ç </th>
            <th>è¯´æ˜</th>
            <th>å¤„ç†æ–¹å¼</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code>CITATION_NOT_FOUND</code></td>
            <td>Citationä¸å­˜åœ¨</td>
            <td>è¿”å›404ï¼ŒUIæ˜¾ç¤ºå ä½ç¬¦</td>
          </tr>
          <tr>
            <td><code>PARSE_FAILED</code></td>
            <td>æ–‡æ¡£è§£æå¤±è´¥</td>
            <td>è®°å½•æ—¥å¿—ï¼Œæç¤ºé‡æ–°ä¸Šä¼ </td>
          </tr>
          <tr>
            <td><code>BINDING_FAILED</code></td>
            <td>Citationç»‘å®šå¤±è´¥</td>
            <td>ç”Ÿæˆæ— Citationç‰ˆæœ¬ï¼Œæç¤ºæ‰‹åŠ¨æ·»åŠ </td>
          </tr>
          <tr>
            <td><code>OVERRIDE_FAILED</code></td>
            <td>ä¿®æ”¹å¤±è´¥</td>
            <td>äº‹åŠ¡å›æ»šï¼Œæç¤ºé‡è¯•</td>
          </tr>
          <tr>
            <td><code>REASON_REQUIRED</code></td>
            <td>ç¼ºå°‘ä¿®æ”¹åŸå› </td>
            <td>å‰ç«¯æ ¡éªŒæç¤º</td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- Section 10: æ€§èƒ½ä¼˜åŒ– -->
    <section id="performance">
      <h2>10. æ€§èƒ½ä¼˜åŒ–</h2>

      <h3>10.1 æ€§èƒ½æŒ‡æ ‡</h3>
      <div class="performance-metrics">
        <div class="metric-card">
          <div class="value">&lt; 50ms</div>
          <div class="label">Hover å“åº”</div>
        </div>
        <div class="metric-card">
          <div class="value">&lt; 200ms</div>
          <div class="label">Popover åŠ è½½</div>
        </div>
        <div class="metric-card">
          <div class="value">&lt; 500ms</div>
          <div class="label">Preview ç”Ÿæˆ</div>
        </div>
        <div class="metric-card">
          <div class="value">&lt; 300ms</div>
          <div class="label">æ‰¹é‡åŠ è½½(100ä¸ª)</div>
        </div>
        <div class="metric-card">
          <div class="value">&lt; 200ms</div>
          <div class="label">ä¿®æ”¹ä¿å­˜</div>
        </div>
      </div>

      <h3>10.2 ä¼˜åŒ–ç­–ç•¥</h3>
      <div class="diagram-container">
        <div class="diagram-title">
          <span>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</span>
          <button class="fullscreen-btn" onclick="toggleFullscreen(this)">å…¨å±</button>
        </div>
        <div class="mermaid">
graph TB
    subgraph "å‰ç«¯ä¼˜åŒ–"
        VIRTUAL[è™šæ‹ŸåŒ–åˆ—è¡¨<br/>å¤§é‡Citationæ—¶]
        PREFETCH[é¢„åŠ è½½<br/>Hoveræ—¶é¢„å–]
        LAZY[æ‡’åŠ è½½<br/>æŒ‰éœ€Preview]
        MEMO[ç»„ä»¶ç¼“å­˜<br/>React.memo]
    end

    subgraph "APIä¼˜åŒ–"
        BATCH[æ‰¹é‡æŸ¥è¯¢<br/>Sectionçº§åˆ«]
        STREAM[æµå¼è¿”å›<br/>å¤§æ–‡ä»¶Preview]
        COMPRESS[å“åº”å‹ç¼©<br/>gzip/br]
    end

    subgraph "æ•°æ®åº“ä¼˜åŒ–"
        INDEX[ç´¢å¼•ä¼˜åŒ–<br/>å¸¸ç”¨æŸ¥è¯¢è·¯å¾„]
        JSONB[JSONBç´¢å¼•<br/>positionå­—æ®µ]
        PARTIAL[éƒ¨åˆ†ç´¢å¼•<br/>override=true]
    end

    subgraph "ç¼“å­˜ä¼˜åŒ–"
        QUERY_CACHE[TanStack Query<br/>å®¢æˆ·ç«¯ç¼“å­˜]
        REDIS[Redis<br/>æœåŠ¡ç«¯ç¼“å­˜]
        CDN[CDN<br/>é™æ€é¢„è§ˆç¼“å­˜]
    end

    VIRTUAL --> PREFETCH
    PREFETCH --> LAZY

    BATCH --> STREAM

    INDEX --> JSONB
    JSONB --> PARTIAL

    QUERY_CACHE --> REDIS
    REDIS --> CDN
        </div>
      </div>

      <h3>10.3 ç¼“å­˜é…ç½®</h3>
      <pre><code>// TanStack Query ç¼“å­˜é…ç½®
export const citationQueryOptions = {
  getById: (id: string) => ({
    queryKey: ['citation', id],
    staleTime: 5 * 60 * 1000,      // 5åˆ†é’Ÿ
    gcTime: 30 * 60 * 1000         // 30åˆ†é’Ÿ
  }),

  getPreview: (id: string) => ({
    queryKey: ['citation', id, 'preview'],
    staleTime: 30 * 60 * 1000,     // 30åˆ†é’Ÿ (æ–‡ä»¶ä¸å˜)
    gcTime: 60 * 60 * 1000         // 1å°æ—¶
  })
};</code></pre>
    </section>

    <footer style="text-align: center; padding: 2rem; color: var(--gray-600);">
      <p>CRE OM Generator - Citation Technical Specification</p>
      <p>Version 1.0.0 | 2026-01-12</p>
    </footer>
  </div>

  <script>
    // åˆå§‹åŒ– Mermaid
    mermaid.initialize({
      startOnLoad: true,
      theme: 'default',
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true,
        curve: 'basis'
      },
      sequence: {
        useMaxWidth: true,
        showSequenceNumbers: true
      }
    });

    // å…¨å±åˆ‡æ¢åŠŸèƒ½
    function toggleFullscreen(btn) {
      const container = btn.closest('.diagram-container');
      container.classList.toggle('fullscreen');
      btn.textContent = container.classList.contains('fullscreen') ? 'é€€å‡ºå…¨å±' : 'å…¨å±';
    }

    // ESC é€€å‡ºå…¨å±
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.diagram-container.fullscreen').forEach(container => {
          container.classList.remove('fullscreen');
          container.querySelector('.fullscreen-btn').textContent = 'å…¨å±';
        });
      }
    });
  </script>
</body>
</html>
